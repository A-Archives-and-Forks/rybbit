"use strict";(()=>{function w(i){let e="__DOUBLE_ASTERISK_TOKEN__",t="__SINGLE_ASTERISK_TOKEN__",n=i.replace(/\*\*/g,e).replace(/\*/g,t).replace(/[.+?^${}()|[\]\\]/g,"\\$&");n=n.replace(new RegExp(`/${e}/`,"g"),"/(?:.+/)?"),n=n.replace(new RegExp(e,"g"),".*"),n=n.replace(/\//g,"\\/");let c=n.replace(new RegExp(t,"g"),"[^/]+");return new RegExp("^"+c+"$")}function g(i,e){for(let t of e)try{if(w(t).test(i))return t}catch(a){console.error(`Invalid pattern: ${t}`,a)}return null}function y(i,e){let t=null;return(...a)=>{t&&clearTimeout(t),t=setTimeout(()=>i(...a),e)}}function b(i){try{let e=window.location.hostname,t=new URL(i).hostname;return t!==e&&t!==""}catch{return!1}}function f(i,e){if(!i)return e;try{let t=JSON.parse(i);return Array.isArray(e)&&!Array.isArray(t)?e:t}catch(t){return console.error("Error parsing JSON:",t),e}}function m(i){let e=i.getAttribute("src");if(!e)return console.error("Script src attribute is missing"),null;let t=e.split("/script.js")[0];if(!t)return console.error("Please provide a valid analytics host"),null;let a=i.getAttribute("data-site-id")||i.getAttribute("site-id");if(!a||isNaN(Number(a)))return console.error("Please provide a valid site ID using the data-site-id attribute"),null;let n=i.getAttribute("data-debounce")?Math.max(0,parseInt(i.getAttribute("data-debounce"))):500,c=f(i.getAttribute("data-skip-patterns"),[]),s=f(i.getAttribute("data-mask-patterns"),[]),r=i.getAttribute("data-api-key")||void 0,o=i.getAttribute("data-replay-batch-size")?Math.max(1,parseInt(i.getAttribute("data-replay-batch-size"))):3,l=i.getAttribute("data-replay-batch-interval")?Math.max(1e3,parseInt(i.getAttribute("data-replay-batch-interval"))):2e3;return console.info(i),{analyticsHost:t,siteId:a,debounceDuration:n,autoTrackPageview:i.getAttribute("data-auto-track-pageview")!=="false",autoTrackSpa:i.getAttribute("data-track-spa")!=="false",trackQuerystring:i.getAttribute("data-track-query")!=="false",trackOutbound:i.getAttribute("data-track-outbound")!=="false",enableWebVitals:i.getAttribute("data-web-vitals")==="true",trackErrors:i.getAttribute("data-track-errors")==="true",enableSessionReplay:i.getAttribute("data-session-replay")==="true",sessionReplayBatchSize:o,sessionReplayBatchInterval:l,skipPatterns:c,maskPatterns:s,apiKey:r}}var d=class{constructor(e,t,a){this.isRecording=!1;this.eventBuffer=[];this.config=e,this.userId=t,this.sendBatch=a}async initialize(){this.config.enableSessionReplay&&(window.rrweb||await this.loadRrweb(),window.rrweb&&this.startRecording())}async loadRrweb(){return new Promise((e,t)=>{let a=document.createElement("script");a.src=`${this.config.analyticsHost}/replay.js`,a.async=!1,a.onload=()=>{e()},a.onerror=()=>t(new Error("Failed to load rrweb")),document.head.appendChild(a)})}startRecording(){if(!(this.isRecording||!window.rrweb||!this.config.enableSessionReplay))try{this.stopRecordingFn=window.rrweb.record({emit:e=>{this.addEvent({type:e.type,data:e.data,timestamp:e.timestamp||Date.now()})},recordCanvas:!0,collectFonts:!0,checkoutEveryNms:3e4,checkoutEveryNth:200,maskAllInputs:!0,maskInputOptions:{password:!0,email:!0},slimDOMOptions:{script:!1,comment:!0,headFavicon:!0,headWhitespace:!0,headMetaDescKeywords:!0,headMetaSocial:!0,headMetaRobots:!0,headMetaHttpEquiv:!0,headMetaAuthorship:!0,headMetaVerification:!0},sampling:{mousemove:!1,mouseInteraction:!0,scroll:150,input:"last"}}),this.isRecording=!0,this.setupBatchTimer()}catch{}}stopRecording(){this.isRecording&&(this.stopRecordingFn&&this.stopRecordingFn(),this.isRecording=!1,this.clearBatchTimer(),this.eventBuffer.length>0&&this.flushEvents())}isActive(){return this.isRecording}addEvent(e){this.eventBuffer.push(e),this.eventBuffer.length>=this.config.sessionReplayBatchSize&&this.flushEvents()}setupBatchTimer(){this.clearBatchTimer(),this.batchTimer=window.setInterval(()=>{this.eventBuffer.length>0&&this.flushEvents()},this.config.sessionReplayBatchInterval)}clearBatchTimer(){this.batchTimer&&(clearInterval(this.batchTimer),this.batchTimer=void 0)}async flushEvents(){if(this.eventBuffer.length===0)return;let e=[...this.eventBuffer];this.eventBuffer=[];let t={userId:this.userId,events:e,metadata:{pageUrl:window.location.href,viewportWidth:screen.width,viewportHeight:screen.height,language:navigator.language}};try{await this.sendBatch(t)}catch{this.eventBuffer.unshift(...e)}}updateUserId(e){this.userId=e}onPageChange(){this.isRecording&&this.flushEvents()}cleanup(){this.stopRecording()}};var u=class{constructor(e){this.customUserId=null;this.config=e,this.loadUserId(),e.enableSessionReplay&&this.initializeSessionReplay()}loadUserId(){try{let e=localStorage.getItem("rybbit-user-id");e&&(this.customUserId=e)}catch{}}async initializeSessionReplay(){try{this.sessionReplayRecorder=new d(this.config,this.customUserId||"",e=>this.sendSessionReplayBatch(e)),await this.sessionReplayRecorder.initialize()}catch(e){console.error("Failed to initialize session replay:",e)}}async sendSessionReplayBatch(e){try{await fetch(`${this.config.analyticsHost}/session-replay/record/${this.config.siteId}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),mode:"cors",keepalive:!1})}catch(t){throw console.error("Failed to send session replay batch:",t),t}}createBasePayload(){let e=new URL(window.location.href),t=e.pathname;if(e.hash&&e.hash.startsWith("#/")&&(t=e.hash.substring(1)),g(t,this.config.skipPatterns))return null;let a=g(t,this.config.maskPatterns);a&&(t=a);let n={site_id:this.config.siteId,hostname:e.hostname,pathname:t,querystring:this.config.trackQuerystring?e.search:"",screenWidth:screen.width,screenHeight:screen.height,language:navigator.language,page_title:document.title,referrer:document.referrer};return this.customUserId&&(n.user_id=this.customUserId),this.config.apiKey&&(n.api_key=this.config.apiKey),n}async sendTrackingData(e){try{await fetch(`${this.config.analyticsHost}/track`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),mode:"cors",keepalive:!0})}catch(t){console.error("Failed to send tracking data:",t)}}track(e,t="",a={}){if(e==="custom_event"&&(!t||typeof t!="string")){console.error("Event name is required and must be a string for custom events");return}let n=this.createBasePayload();if(!n)return;let c={...n,type:e,event_name:t,properties:e==="custom_event"||e==="outbound"||e==="error"?JSON.stringify(a):void 0};this.sendTrackingData(c)}trackPageview(){this.track("pageview")}trackEvent(e,t={}){this.track("custom_event",e,t)}trackOutbound(e,t="",a="_self"){this.track("outbound","",{url:e,text:t,target:a})}trackWebVitals(e){let t=this.createBasePayload();if(!t)return;let a={...t,type:"performance",event_name:"web-vitals",...e};this.sendTrackingData(a)}trackError(e,t={}){let a=window.location.origin,n=t.filename||"",c=e.stack||"";if(n)try{if(new URL(n).origin!==a)return}catch{}else if(c&&!c.includes(a))return;let s={message:e.message?.substring(0,500)||"Unknown error",stack:c.substring(0,2e3)||""};if(n&&(s.fileName=n),t.lineno){let r=typeof t.lineno=="string"?parseInt(t.lineno,10):t.lineno;r&&r!==0&&(s.lineNumber=r)}if(t.colno){let r=typeof t.colno=="string"?parseInt(t.colno,10):t.colno;r&&r!==0&&(s.columnNumber=r)}for(let r in t)!["lineno","colno"].includes(r)&&t[r]!==void 0&&(s[r]=t[r]);this.track("error",e.name||"Error",s)}identify(e){if(typeof e!="string"||e.trim()===""){console.error("User ID must be a non-empty string");return}this.customUserId=e.trim();try{localStorage.setItem("rybbit-user-id",this.customUserId)}catch{console.warn("Could not persist user ID to localStorage")}this.sessionReplayRecorder&&this.sessionReplayRecorder.updateUserId(this.customUserId)}clearUserId(){this.customUserId=null;try{localStorage.removeItem("rybbit-user-id")}catch{}}getUserId(){return this.customUserId}startSessionReplay(){this.sessionReplayRecorder?this.sessionReplayRecorder.startRecording():console.warn("Session replay not initialized")}stopSessionReplay(){this.sessionReplayRecorder&&this.sessionReplayRecorder.stopRecording()}isSessionReplayActive(){return this.sessionReplayRecorder?.isActive()??!1}onPageChange(){this.sessionReplayRecorder&&this.sessionReplayRecorder.onPageChange()}cleanup(){this.sessionReplayRecorder&&this.sessionReplayRecorder.cleanup()}};var h=class{constructor(e,t){this.data={lcp:null,cls:null,inp:null,fcp:null,ttfb:null};this.sent=!1;this.timeout=null;this.onReadyCallback=null;this.initialized=!1;this.config=e,this.onReadyCallback=t}async initialize(){if(!this.initialized){if(window.webVitals||await this.loadWebVitals(),!window.webVitals){console.warn("Failed to load web-vitals, metrics collection disabled");return}this.initialized=!0;try{window.webVitals.onLCP(this.collectMetric.bind(this)),window.webVitals.onCLS(this.collectMetric.bind(this)),window.webVitals.onINP(this.collectMetric.bind(this)),window.webVitals.onFCP(this.collectMetric.bind(this)),window.webVitals.onTTFB(this.collectMetric.bind(this)),this.timeout=setTimeout(()=>{this.sent||this.sendData()},2e4),window.addEventListener("beforeunload",()=>{this.sent||this.sendData()})}catch(e){console.warn("Error initializing web vitals tracking:",e)}}}async loadWebVitals(){return new Promise(e=>{let t=document.createElement("script");t.src=`${this.config.analyticsHost}/metrics.js`,t.async=!1,t.onload=()=>{console.log("[Web Vitals] Library loaded successfully"),e()},t.onerror=()=>{console.error("[Web Vitals] Failed to load library"),e()},document.head.appendChild(t)})}collectMetric(e){if(this.sent)return;let t=e.name.toLowerCase();this.data[t]=e.value,Object.values(this.data).every(n=>n!==null)&&this.sendData()}sendData(){this.sent||(this.sent=!0,this.timeout&&(clearTimeout(this.timeout),this.timeout=null),this.onReadyCallback&&this.onReadyCallback(this.data))}getData(){return{...this.data}}};(function(){let i=document.currentScript;if(!i){console.error("Could not find current script tag");return}if(window.__RYBBIT_OPTOUT__||localStorage.getItem("disable-rybbit")!==null){window.rybbit={pageview:()=>{},event:()=>{},trackOutbound:()=>{},identify:()=>{},clearUserId:()=>{},getUserId:()=>null,startSessionReplay:()=>{},stopSessionReplay:()=>{},isSessionReplayActive:()=>!1};return}let e=m(i);if(!e)return;let t=new u(e);e.enableWebVitals&&new h(e,r=>{t.trackWebVitals(r)}).initialize().catch(r=>{console.warn("Failed to initialize web vitals:",r)}),e.trackErrors&&(window.addEventListener("error",s=>{t.trackError(s.error||new Error(s.message),{filename:s.filename,lineno:s.lineno,colno:s.colno})}),window.addEventListener("unhandledrejection",s=>{let r=s.reason instanceof Error?s.reason:new Error(String(s.reason));t.trackError(r,{type:"unhandledrejection"})}));let a=()=>t.trackPageview(),n=e.debounceDuration>0?y(a,e.debounceDuration):a;function c(){if(document.addEventListener("click",function(s){let r=s.target;for(;r&&r!==document.documentElement;){if(r.hasAttribute("data-rybbit-event")){let o=r.getAttribute("data-rybbit-event");if(o){let l={};for(let p of r.attributes)if(p.name.startsWith("data-rybbit-prop-")){let v=p.name.replace("data-rybbit-prop-","");l[v]=p.value}t.trackEvent(o,l)}break}r=r.parentElement}if(e.trackOutbound){let o=s.target.closest("a");o?.href&&b(o.href)&&t.trackOutbound(o.href,o.innerText||o.textContent||"",o.target||"_self")}}),e.autoTrackSpa){let s=history.pushState,r=history.replaceState;history.pushState=function(...o){s.apply(this,o),n(),t.onPageChange()},history.replaceState=function(...o){r.apply(this,o),n(),t.onPageChange()},window.addEventListener("popstate",()=>{n(),t.onPageChange()}),window.addEventListener("hashchange",()=>{n(),t.onPageChange()})}}window.rybbit={pageview:()=>t.trackPageview(),event:(s,r={})=>t.trackEvent(s,r),trackOutbound:(s,r="",o="_self")=>t.trackOutbound(s,r,o),identify:s=>t.identify(s),clearUserId:()=>t.clearUserId(),getUserId:()=>t.getUserId(),startSessionReplay:()=>t.startSessionReplay(),stopSessionReplay:()=>t.stopSessionReplay(),isSessionReplayActive:()=>t.isSessionReplayActive()},c(),window.addEventListener("beforeunload",()=>{t.cleanup()}),e.autoTrackPageview&&t.trackPageview()})();})();
